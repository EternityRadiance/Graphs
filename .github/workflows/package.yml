name: Create Graph Archive

on:
  workflow_dispatch:
    inputs:
      graph_names:
        description: 'Graph names'
        required: true
        type: string
      request_id:
        description: 'Request ID'
        required: true
        type: string

jobs:
  create-zip:
    runs-on: ubuntu-latest
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      
    - name: Download graphs and create ZIP
      env:
        GRAPH_NAMES: ${{ github.event.inputs.graph_names }}
        REQUEST_ID: ${{ github.event.inputs.request_id }}
      run: |
        # Создаем ZIP напрямую с файлами в корне
        ZIP_NAME="graphs-$REQUEST_ID.zip"
        
        # Создаем пустой ZIP
        touch "$ZIP_NAME"
        
        IFS=',' read -ra GRAPHS <<< "$GRAPH_NAMES"
        
        # Скачиваем и добавляем каждый файл в ZIP
        for graph in "${GRAPHS[@]}"; do
          graph_clean=$(echo "$graph" | xargs)
          if [ -n "$graph_clean" ]; then
            URL="https://raw.githubusercontent.com/${{ github.repository }}/main/data/${graph_clean}.json"
            
            # Скачиваем во временный файл
            TEMP_FILE="$(mktemp)"
            if curl -s -f -o "$TEMP_FILE" "$URL"; then
              # Добавляем файл в ZIP (в корень архива)
              zip -q -j "$ZIP_NAME" "$TEMP_FILE"
              # Переименовываем файл внутри ZIP
              echo "$graph_clean.json" | zipnote -w "$ZIP_NAME"
            fi
            rm -f "$TEMP_FILE"
          fi
        done
        
        # Проверяем, создан ли ZIP
        if [ -s "$ZIP_NAME" ]; then
          echo "ZIP created: $ZIP_NAME"
        else
          echo "ZIP creation failed"
          exit 1
        fi
      
    - name: Upload artifact
      uses: actions/upload-artifact@v4
      with:
        name: graphs-${{ github.event.inputs.request_id }}
        path: graphs-*.zip
        retention-days: 1
