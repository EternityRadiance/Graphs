name: Create Graph Archive

on:
  workflow_dispatch:
    inputs:
      graph_names:
        description: 'Graph names'
        required: true
        type: string
      request_id:
        description: 'Request ID'
        required: true
        type: string

jobs:
  create-zip:
    runs-on: ubuntu-latest
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      
    - name: Download graphs and create ZIP
      env:
        GRAPH_NAMES: ${{ github.event.inputs.graph_names }}
        REQUEST_ID: ${{ github.event.inputs.request_id }}
      run: |
        ZIP_NAME="graphs-$REQUEST_ID.zip"
        
        # Удаляем старый ZIP если существует
        rm -f "$ZIP_NAME"
        
        IFS=',' read -ra GRAPHS <<< "$GRAPH_NAMES"
        
        # Простой вариант: создаем архив напрямую
        for graph in "${GRAPHS[@]}"; do
          graph_clean=$(echo "$graph" | xargs)
          if [ -n "$graph_clean" ]; then
            URL="https://raw.githubusercontent.com/${{ github.repository }}/main/data/${graph_clean}.json"
            curl -s -f -o "${graph_clean}.json" "$URL" && \
            zip -q "$ZIP_NAME" "${graph_clean}.json" && \
            rm -f "${graph_clean}.json"
          fi
        done
        
        # Проверяем результат
        if [ -f "$ZIP_NAME" ]; then
          echo "ZIP created: $(ls -lh "$ZIP_NAME")"
          echo "Files in ZIP:"
          unzip -l "$ZIP_NAME" | tail -n +4 | head -n -2
        else
          echo "ZIP creation failed"
          exit 1
        fi
      
    - name: Upload artifact
      uses: actions/upload-artifact@v4
      with:
        name: graphs-${{ github.event.inputs.request_id }}
        path: graphs-*.zip
        retention-days: 1
