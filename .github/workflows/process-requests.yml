name: Process Graph Requests

on:
  push:
    paths:
      - 'requests/request_*.json'
    branches: [ main ]
  workflow_dispatch:

jobs:
  process-graphs:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      with:
        fetch-depth: 0  # –ü–æ–ª–Ω–∞—è –∏—Å—Ç–æ—Ä–∏—è –¥–ª—è –¥–æ—Å—Ç—É–ø–∞ –∫–æ –≤—Å–µ–º —Ñ–∞–π–ª–∞–º
        
    - name: Set up Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '18'
        
    - name: Install dependencies
      run: |
        cd .github/scripts
        npm install
        
    - name: Find latest request
      id: find-request
      run: |
        # –ò—â–µ–º –ø–æ—Å–ª–µ–¥–Ω–∏–π —Å–æ–∑–¥–∞–Ω–Ω—ã–π/–∏–∑–º–µ–Ω–µ–Ω–Ω—ã–π —Ñ–∞–π–ª –∑–∞–ø—Ä–æ—Å–∞
        LATEST_REQUEST=$(find requests -name "request_*.json" -type f -printf "%T@ %p\n" | sort -nr | head -n1 | cut -d' ' -f2-)
        if [ -z "$LATEST_REQUEST" ]; then
          echo "No request files found"
          exit 1
        fi
        echo "latest_request=$LATEST_REQUEST" >> $GITHUB_OUTPUT
        echo "üìã Processing: $LATEST_REQUEST"
        
    - name: Process graphs from data/ directory
      id: process
      run: |
        echo "üìÅ Looking for graphs in data/ directory..."
        ls -la data/ | head -10  # –ü–æ–∫–∞–∂–µ–º –ø–µ—Ä–≤—ã–µ 10 —Ñ–∞–π–ª–æ–≤ –¥–ª—è –æ—Ç–ª–∞–¥–∫–∏
        node .github/scripts/process-request.js "${{ steps.find-request.outputs.latest_request }}" "graph-bundle.zip"
        
    - name: Upload bundle to release
      uses: softprops/action-gh-release@v1
      with:
        files: graph-bundle.zip
        tag_name: bundle-${{ github.run_id }}
        name: "Graph Bundle ${{ github.run_id }}"
        body: |
          –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ —Å–æ–±—Ä–∞–Ω–Ω—ã–π bundle –≥—Ä–∞—Ñ–æ–≤
          - –ó–∞–ø—Ä–æ—Å: ${{ steps.find-request.outputs.latest_request }}
          - –í—Ä–µ–º—è: ${{ github.event.head_commit.timestamp }}
          - –î–∏—Ä–µ–∫—Ç–æ—Ä–∏—è –¥–∞–Ω–Ω—ã—Ö: data/
          
    - name: Show processing summary
      run: |
        echo "‚úÖ Processing completed!"
        echo "üì¶ Bundle: graph-bundle.zip"
        echo "üîó Download URL: https://github.com/${{ github.repository }}/releases/download/bundle-${{ github.run_id }}/graph-bundle.zip"
