name: Auto Graph Processing

on:
  push:
    paths:
      - 'data/**'
  pull_request:
    types: [closed]
    paths:
      - 'data/**'
  workflow_dispatch:

jobs:
  normalize-files:
    runs-on: ubuntu-latest
    permissions:
      contents: write

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Normalize graph files
        run: |
          echo "=== –ù–û–†–ú–ê–õ–ò–ó–ê–¶–ò–Ø –§–ê–ô–õ–û–í –í data ==="

          DIR="data"
          cd "$DIR" || exit

          # –°–æ–∑–¥–∞–µ–º –≤—Ä–µ–º–µ–Ω–Ω—É—é –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏—é –¥–ª—è –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏
          mkdir -p temp_rename

          # –ü–æ–ª—É—á–∞–µ–º –∏ —Å–æ—Ä—Ç–∏—Ä—É–µ–º —Ñ–∞–π–ª—ã
          FILES=$(find . -maxdepth 1 -name 'graph_*.json' | sort -V)
          
          # –ü—Ä–æ–≤–µ—Ä—è–µ–º –Ω—É–º–µ—Ä–∞—Ü–∏—é
          COUNT=1
          NEEDS_RENAME=false
          RENAME_LIST=""

          for FILE in $FILES; do
            FILE=$(basename "$FILE")
            EXPECTED="graph_${COUNT}.json"
            if [ "$FILE" != "$EXPECTED" ]; then
              NEEDS_RENAME=true
              RENAME_LIST="${RENAME_LIST}${FILE} -> ${EXPECTED}\n"
            fi
            COUNT=$((COUNT + 1))
          done

          if [ "$NEEDS_RENAME" = "false" ]; then
            echo "‚úÖ –§–∞–π–ª—ã —É–∂–µ –Ω–æ—Ä–º–∞–ª–∏–∑–æ–≤–∞–Ω—ã"
            exit 0
          fi

          echo "üìã –ü–ª–∞–Ω –ø–µ—Ä–µ–∏–º–µ–Ω–æ–≤–∞–Ω–∏—è:"
          echo -e "$RENAME_LIST"

          # –í—ã–ø–æ–ª–Ω—è–µ–º –ø–µ—Ä–µ–∏–º–µ–Ω–æ–≤–∞–Ω–∏–µ —á–µ—Ä–µ–∑ –ø—Ä–æ–º–µ–∂—É—Ç–æ—á–Ω—ã–µ –∏–º–µ–Ω–∞
          COUNT=1
          for FILE in $FILES; do
            FILE=$(basename "$FILE")
            mv "$FILE" "temp_rename/file_${COUNT}.tmp"
            COUNT=$((COUNT + 1))
          done

          # –ü—Ä–∏—Å–≤–∞–∏–≤–∞–µ–º –æ–∫–æ–Ω—á–∞—Ç–µ–ª—å–Ω—ã–µ –∏–º–µ–Ω–∞
          COUNT=1
          for TMP_FILE in temp_rename/*.tmp; do
            NEW_NAME="graph_${COUNT}.json"
            mv "$TMP_FILE" "$NEW_NAME"
            echo "‚úÖ –ü–µ—Ä–µ–∏–º–µ–Ω–æ–≤–∞–Ω–æ: graph_*.json -> $NEW_NAME"
            COUNT=$((COUNT + 1))
          done

          # –£–±–∏—Ä–∞–µ–º –≤—Ä–µ–º–µ–Ω–Ω—É—é –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏—é
          rmdir temp_rename 2>/dev/null || true

      - name: Counting Authors
        run: |
          echo "=== –ü–æ–¥—Å—á—ë—Ç –∫–æ–ª-–≤–æ –≥—Ä–∞—Ñ–æ–≤ –Ω–∞ –∞–≤—Ç–æ—Ä–∞ ==="
          FILE="author-graphs.txt"
          printf '–ê–≤—Ç–æ—Ä\t–ö–æ–ª-–≤–æ –ì—Ä–∞—Ñ–æ–≤\n' > "$FILE"
          
          find data -name "*.json" -exec grep -h '"author":' {} \; | \
          sed -n 's/.*"author":\s*"\([^"]*\)".*/\1/p' | \
          sort | \
          uniq -c | \
          while read count author; do 
            printf "%s\t%s\n" "$author" "$count" >> "$FILE"
          done
          
          echo "=== –†–µ–∑—É–ª—å—Ç–∞—Ç ==="
          cat "$FILE"

      - name: Commit and push changes
        run: |
          git config --global user.name 'github-actions[bot]'
          git config --global user.email 'github-actions[bot]@users.noreply.github.com'
          git add --all
          if ! git diff --staged --quiet; then
            git commit -m "Auto-processing graph"
            git push
            echo "‚úÖ –ò–∑–º–µ–Ω–µ–Ω–∏—è –∑–∞–ø—É—à–µ–Ω—ã"
          else
            echo "‚ÑπÔ∏è –ù–µ—Ç –∏–∑–º–µ–Ω–µ–Ω–∏–π –¥–ª—è –∫–æ–º–º–∏—Ç–∞"
          fi 
